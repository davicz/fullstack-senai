<!-- CONTAINER GERAL -->
<div class="space-y-4" *ngIf="!isEventLoading; else loadingEvent">
    <!-- ERRO GERAL -->
    <div *ngIf="eventError" class="rounded-md bg-red-50 px-4 py-3 text-sm text-red-700">
        {{ eventError }}
    </div>

    <ng-container *ngIf="event">
        <!-- HEADER / BREADCRUMB -->
        <div class="flex items-center justify-between">
            <div>
                <div class="mb-1 text-xs text-gray-400">
                    Avaliações
                    <span class="mx-1">&gt;</span>
                    <span class="text-gray-500 uppercase">{{ event.type }}</span>
                    <span class="mx-1">&gt;</span>
                    <span class="text-gray-500">{{ event.name }}</span>
                </div>
                <h1 class="text-lg font-semibold text-gray-800">
                    Detalhes do Evento de Avaliação
                </h1>
                <p class="text-xs text-gray-500">
                    Visualize as informações do evento e acompanhe o agendamento das provas.
                </p>
            </div>

            <div class="flex items-center gap-3">
                <!-- Status -->
                <span class="inline-flex items-center gap-1 rounded-full px-3 py-1 text-xs font-medium"
                    [ngClass]="getStatusBadge().color">
                    <span class="h-2 w-2 rounded-full bg-red-500" *ngIf="event.status === 'closed'"></span>
                    <span class="h-2 w-2 rounded-full bg-green-500" *ngIf="event.status === 'open'"></span>
                    {{ getStatusBadge().label }}
                </span>

                <!-- Voltar -->
                <button (click)="backToList()"
                    class="rounded-md border border-gray-300 px-4 py-2 text-xs font-medium text-gray-700 shadow-sm transition hover:bg-gray-100">
                    Voltar
                </button>
            </div>
        </div>

        <!-- CARDS SUPERIORES -->
        <div class="grid gap-4 rounded-md border border-gray-200 bg-white p-4 md:grid-cols-2 xl:grid-cols-4">
            <!-- Card Evento -->
            <div class="flex flex-col justify-between border-r border-gray-100 pr-4">
                <div class="mb-1 text-[10px] font-semibold text-gray-500">EVENTO</div>
                <div class="text-sm font-semibold text-gray-800">
                    {{ event.name }}
                </div>
                <div class="text-[11px] text-gray-500">/ {{ event.type | uppercase }}</div>
                <div class="mt-3 text-[11px] text-gray-500">
                    Vigência:
                    <span class="font-medium text-gray-700">
                        {{ formatDate(event.start_date) }} - {{ formatDate(event.end_date) }}
                    </span>
                </div>
            </div>

            <!-- Card Agendamento de Provas -->
            <div class="flex flex-col justify-between border-r border-gray-100 pr-4">
                <div class="mb-1 text-[10px] font-semibold text-gray-500">
                    AGENDAMENTO DE PROVAS
                </div>
                <div class="text-sm font-medium text-gray-800">
                    {{ schedulingStartDisplay }} → {{ schedulingEndDisplay }}
                </div>
                <div class="mt-1 text-[11px] text-gray-500">
                    Período permitido para agendamento das provas.
                </div>
                <div class="mt-2 text-[11px] text-gray-500">
                    Os alunos só poderão agendar dentro deste período.
                </div>
            </div>

            <!-- Card Alunos Agendados -->
            <div class="flex flex-col justify-between border-r border-gray-100 pr-4">
                <div class="mb-1 text-[10px] font-semibold text-gray-500">
                    ALUNOS AGENDADOS
                </div>
                <div class="flex items-baseline gap-2">
                    <span class="text-2xl font-semibold text-blue-600">
                        {{ scheduledCount }}
                    </span>
                    <span class="text-[11px] text-gray-500">
                        Total: {{ totalStudents }} &nbsp; • &nbsp; {{ scheduledPercent }}% agendados
                    </span>
                </div>
                <div class="mt-2 h-2 w-full overflow-hidden rounded-full bg-gray-100">
                    <div class="h-full bg-blue-500" [style.width.%]="scheduledPercent"></div>
                </div>
            </div>

            <!-- Card Provas realizadas -->
            <div class="flex flex-col justify-between">
                <div class="mb-1 text-[10px] font-semibold text-gray-500">
                    PROVAS REALIZADAS
                </div>
                <div class="flex items-baseline gap-2">
                    <span class="text-2xl font-semibold text-green-600">
                        {{ completedCount }}
                    </span>
                    <span class="text-[11px] text-gray-500">
                        Convidados: {{ invitedCount }} &nbsp; • &nbsp;
                        {{ completedPercent }}% concluíram
                    </span>
                </div>
                <div class="mt-2 h-2 w-full overflow-hidden rounded-full bg-gray-100">
                    <div class="h-full bg-green-500" [style.width.%]="completedPercent"></div>
                </div>
            </div>
        </div>

        <!-- ABAS -->
        <div class="mt-2 border-b border-gray-200">
            <div class="flex gap-6 text-xs font-medium text-gray-500">
                <button class="border-b-2 px-1 py-3" [ngClass]="{
            'border-blue-600 text-blue-600': activeTab === 'courses',
            'border-transparent': activeTab !== 'courses'
          }" (click)="setTab('courses')">
                    Cursos
                </button>
                <button class="border-b-2 px-1 py-3" [ngClass]="{
            'border-blue-600 text-blue-600': activeTab === 'admins',
            'border-transparent': activeTab !== 'admins'
          }" (click)="setTab('admins')">
                    Administradores
                </button>
                <button class="border-b-2 px-1 py-3" [ngClass]="{
            'border-blue-600 text-blue-600': activeTab === 'teachers',
            'border-transparent': activeTab !== 'teachers'
          }" (click)="setTab('teachers')">
                    Docentes
                </button>
                <button class="border-b-2 px-1 py-3" [ngClass]="{
            'border-blue-600 text-blue-600': activeTab === 'scheduling',
            'border-transparent': activeTab !== 'scheduling'
          }" (click)="setTab('scheduling')">
                    Agendamento de Provas
                </button>
            </div>
        </div>

        <!-- PLACEHOLDER OUTRAS ABAS -->
        <div *ngIf="activeTab !== 'scheduling'"
            class="rounded-md border border-gray-200 bg-white p-6 text-xs text-gray-500">
            Esta funcionalidade estará disponível em breve.
        </div>

        <!-- ============================= -->
        <!--        ABA: AGENDAMENTO      -->
        <!-- ============================= -->
        <div *ngIf="activeTab === 'scheduling'">
            <!-- RESUMO + GERENCIAR ALUNOS -->
            <div
                class="mt-3 flex flex-col gap-3 rounded-md border border-gray-200 bg-white px-4 py-3 text-xs text-gray-700 md:flex-row md:items-center md:justify-between">
                <div class="flex flex-wrap items-center gap-4">
                    <div>
                        <span class="text-sm font-semibold text-blue-600">
                            {{ totalStudents }}
                        </span>
                        <span class="ml-1">alunos no evento</span>
                    </div>
                    <div class="border-l pl-4">
                        Convidados:
                        <span class="font-semibold">{{ invitedCount }}</span>
                    </div>
                    <div class="border-l pl-4">
                        Agendados:
                        <span class="font-semibold">{{ scheduledCount }}</span>
                    </div>
                    <div class="border-l pl-4">
                        Realizaram:
                        <span class="font-semibold">{{ completedCount }}</span>
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    <span class="text-[11px] text-gray-500">
                        Exibindo {{ filteredStudents.length }} de {{ students.length }} alunos
                    </span>

                    <button (click)="openAddStudentsModal()"
                        class="flex items-center gap-2 rounded-md border px-3 py-1.5 text-xs font-medium text-gray-700 transition hover:bg-gray-100">
                        <i class="fa-solid fa-user-group text-xs"></i>
                        Gerenciar alunos
                    </button>
                </div>
            </div>

            <!-- FILTROS -->
            <div class="mt-3 rounded-md border border-gray-200 bg-white px-4 py-3 text-xs text-gray-700">
                <div class="flex flex-col gap-3 md:flex-row md:items-end">
                    <!-- Busca -->
                    <div class="flex-1">
                        <label class="mb-1 block text-[11px] text-gray-500">Buscar por nome ou CPF...</label>
                        <input type="text" [(ngModel)]="searchStudent" (input)="applyStudentFilters()"
                            class="w-full rounded-md border px-3 py-2 text-xs" placeholder="Nome do aluno ou CPF" />
                    </div>

                    <!-- Turma -->
                    <div class="w-full md:w-56">
                        <label class="mb-1 block text-[11px] text-gray-500">Turma</label>
                        <select [(ngModel)]="filterClass" (change)="applyStudentFilters()"
                            class="w-full rounded-md border px-3 py-2 text-xs">
                            <option [ngValue]="null">Todas as turmas</option>
                            <option *ngFor="let c of availableClasses" [ngValue]="c">
                                {{ c }}
                            </option>
                        </select>
                    </div>

                    <!-- Status -->
                    <div class="w-full md:w-56">
                        <label class="mb-1 block text-[11px] text-gray-500">Status do agendamento</label>
                        <select [(ngModel)]="filterStatus" (change)="applyStudentFilters()"
                            class="w-full rounded-md border px-3 py-2 text-xs">
                            <option value="all">Todos os status</option>
                            <option value="not_scheduled">Não agendado</option>
                            <option value="invited">Convite enviado</option>
                            <option value="scheduled">Agendado</option>
                            <option value="completed">Prova realizada</option>
                        </select>
                    </div>

                    <!-- Limpar -->
                    <div class="flex items-center">
                        <button (click)="clearStudentFilters()"
                            class="mt-4 inline-flex items-center gap-1 rounded-md border px-3 py-2 text-xs font-medium text-gray-600 transition hover:bg-gray-100 md:mt-0">
                            <i class="fa-solid fa-rotate-left text-xs"></i>
                            Limpar filtros
                        </button>
                    </div>
                </div>
            </div>

            <!-- LISTA DE ALUNOS -->
            <div class="mt-3 rounded-md border border-gray-200 bg-white">
                <!-- Loading / erro -->
                <div *ngIf="isStudentsLoading" class="p-8 text-center text-xs text-gray-500">
                    Carregando alunos...
                </div>
                <div *ngIf="studentsError && !isStudentsLoading" class="p-4 text-center text-xs text-red-600">
                    {{ studentsError }}
                </div>

                <!-- Sem alunos -->
                <div *ngIf="
            !isStudentsLoading &&
            !studentsError &&
            filteredStudents.length === 0
          " class="p-8 text-center text-xs text-gray-400">
                    Nenhum aluno encontrado com os filtros atuais.
                </div>

                <!-- Lista -->
                <div *ngIf="
            !isStudentsLoading &&
            !studentsError &&
            filteredStudents.length > 0
          ">
                    <div *ngFor="let s of filteredStudents; let i = index"
                        class="border-t border-gray-100 px-4 py-3 text-xs">
                        <!-- Linha superior: nome + cpf + turma + ações -->
                        <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
                            <div>
                                <div class="font-semibold text-gray-800">
                                    {{ s.student_name }}
                                </div>
                                <div class="text-[11px] text-gray-500">
                                    CPF: {{ s.student_cpf }} &nbsp; • &nbsp;
                                    Turma: {{ s.school_class_name }}
                                </div>
                            </div>

                            <div class="flex items-center gap-2">
                                <!-- Botão AGENDAR / REAGENDAR -->
                                <button *ngIf="!s.completed_at" (click)="openScheduleModal(s)"
                                    class="inline-flex items-center gap-1 rounded-md border px-3 py-1.5 text-[11px] font-medium text-gray-700 transition hover:bg-gray-100">
                                    <i class="fa-regular fa-calendar-days text-xs"></i>
                                    {{ s.scheduled_date ? 'Reagendar' : 'Agendar' }}
                                </button>

                                <!-- Mais ações (placeholder, sem menu ainda) -->
                                <button
                                    class="inline-flex h-7 w-7 items-center justify-center rounded-full transition hover:bg-gray-100"
                                    title="Mais ações">
                                    <i class="fa-solid fa-ellipsis-vertical text-sm text-gray-600"></i>
                                </button>

                                <!-- Deletar -->
                                <button (click)="removeStudent(s)"
                                    class="inline-flex h-7 w-7 items-center justify-center rounded-full transition hover:bg-red-50"
                                    title="Remover do evento">
                                    <i class="fa-solid fa-trash-can text-sm text-red-500"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Linha do tempo -->
                        <div class="mt-3 flex items-center">
                            <!-- Step 0 -->
                            <div class="flex flex-col items-center">
                                <div class="flex h-7 w-7 items-center justify-center rounded-full border text-[11px] font-semibold"
                                    [ngClass]="getStepClass(s, 0)">
                                    1
                                </div>
                                <div class="mt-1 text-[10px] text-gray-500">
                                    {{ getStepLabel(0) }}
                                </div>
                                <div class="mt-1 text-[10px] text-gray-400">
                                    {{ getStepDate(s, 0) }}
                                </div>
                            </div>

                            <!-- linha -->
                            <div class="mx-2 h-px flex-1 bg-gray-200"></div>

                            <!-- Step 1 -->
                            <div class="flex flex-col items-center">
                                <div class="flex h-7 w-7 items-center justify-center rounded-full border text-[11px] font-semibold"
                                    [ngClass]="getStepClass(s, 1)">
                                    2
                                </div>
                                <div class="mt-1 text-[10px] text-gray-500">
                                    {{ getStepLabel(1) }}
                                </div>
                                <div class="mt-1 text-[10px] text-gray-400">
                                    {{ getStepDate(s, 1) }}
                                </div>
                            </div>

                            <div class="mx-2 h-px flex-1 bg-gray-200"></div>

                            <!-- Step 2 -->
                            <div class="flex flex-col items-center">
                                <div class="flex h-7 w-7 items-center justify-center rounded-full border text-[11px] font-semibold"
                                    [ngClass]="getStepClass(s, 2)">
                                    3
                                </div>
                                <div class="mt-1 text-[10px] text-gray-500">
                                    {{ getStepLabel(2) }}
                                </div>
                                <div class="mt-1 text-[10px] text-gray-400">
                                    {{ getStepDate(s, 2) }}
                                </div>
                            </div>

                            <div class="mx-2 h-px flex-1 bg-gray-200"></div>

                            <!-- Step 3 -->
                            <div class="flex flex-col items-center">
                                <div class="flex h-7 w-7 items-center justify-center rounded-full border text-[11px] font-semibold"
                                    [ngClass]="getStepClass(s, 3)">
                                    4
                                </div>
                                <div class="mt-1 text-[10px] text-gray-500">
                                    {{ getStepLabel(3) }}
                                </div>
                                <div class="mt-1 text-[10px] text-gray-400">
                                    {{ getStepDate(s, 3) }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MODAL ADICIONAR ALUNOS -->
            <div *ngIf="isAddStudentsModalOpen" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40"
                (click)="closeAddStudentsModal()">
                <div class="w-full max-w-lg rounded-lg border border-gray-200 bg-white shadow-xl"
                    (click)="$event.stopPropagation()">
                    <div class="border-b px-4 py-3 text-sm font-semibold text-gray-800">
                        Gerenciar alunos do evento
                    </div>
                    <div class="space-y-3 px-4 py-3 text-xs text-gray-700">
                        <p>
                            Cole abaixo uma lista de CPFs (um por linha) para adicionar alunos a
                            este evento de avaliação.
                        </p>

                        <textarea [(ngModel)]="addStudentsText" rows="6"
                            class="w-full rounded-md border px-3 py-2 text-xs"
                            placeholder="12345678901&#10;98765432100&#10;..."></textarea>

                        <div *ngIf="addStudentsError" class="rounded-md bg-red-50 px-3 py-2 text-red-700">
                            {{ addStudentsError }}
                        </div>
                        <div *ngIf="addStudentsSuccess" class="rounded-md bg-green-50 px-3 py-2 text-green-700">
                            {{ addStudentsSuccess }}
                        </div>
                    </div>
                    <div class="flex justify-end gap-2 border-t bg-gray-50 px-4 py-3 text-xs">
                        <button (click)="closeAddStudentsModal()"
                            class="rounded-md border px-4 py-1.5 font-medium text-gray-700 transition hover:bg-gray-100">
                            Cancelar
                        </button>
                        <button (click)="submitAddStudents()" [disabled]="addStudentsLoading"
                            class="rounded-md bg-blue-600 px-4 py-1.5 font-medium text-white transition hover:bg-blue-700 disabled:opacity-50">
                            {{ addStudentsLoading ? 'Salvando...' : 'Adicionar alunos' }}
                        </button>
                    </div>
                </div>
            </div>

            <!-- MODAL AGENDAR ALUNO -->
            <div *ngIf="isScheduleModalOpen" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40"
                (click)="closeScheduleModal()">
                <div class="w-full max-w-sm rounded-lg border border-gray-200 bg-white shadow-xl"
                    (click)="$event.stopPropagation()">
                    <div class="border-b px-4 py-3 text-sm font-semibold text-gray-800">
                        Agendar prova
                    </div>
                    <div class="space-y-3 px-4 py-3 text-xs text-gray-700">
                        <p class="text-[11px] text-gray-500">
                            Aluno:
                            <span class="font-semibold">
                                {{ scheduleStudentSelected?.student_name }}
                            </span>
                        </p>

                        <label class="mb-1 block text-[11px] text-gray-500">Data e hora do agendamento</label>
                        <input type="datetime-local" [(ngModel)]="scheduleDateTime"
                            class="w-full rounded-md border px-3 py-2 text-xs" />

                        <div *ngIf="scheduleError" class="rounded-md bg-red-50 px-3 py-2 text-red-700">
                            {{ scheduleError }}
                        </div>
                        <div *ngIf="scheduleSuccess" class="rounded-md bg-green-50 px-3 py-2 text-green-700">
                            {{ scheduleSuccess }}
                        </div>
                    </div>
                    <div class="flex justify-end gap-2 border-t bg-gray-50 px-4 py-3 text-xs">
                        <button (click)="closeScheduleModal()"
                            class="rounded-md border px-4 py-1.5 font-medium text-gray-700 transition hover:bg-gray-100">
                            Cancelar
                        </button>
                        <button (click)="submitSchedule()" [disabled]="scheduleLoading"
                            class="rounded-md bg-blue-600 px-4 py-1.5 font-medium text-white transition hover:bg-blue-700 disabled:opacity-50">
                            {{ scheduleLoading ? 'Salvando...' : 'Salvar agendamento' }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- fim da aba scheduling -->
    </ng-container>
</div>

<!-- LOADING GERAL -->
<ng-template #loadingEvent>
    <div class="rounded-md bg-white p-8 text-center text-sm text-gray-500">
        Carregando dados do evento...
    </div>
</ng-template>