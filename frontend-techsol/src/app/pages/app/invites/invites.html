<!-- HEADER -->
<div class="mb-4 flex items-center justify-between">
  <h1 class="text-xl font-semibold text-gray-800">Convites</h1>

  <button (click)="openInviteModal()"
    class="flex items-center gap-1 rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow hover:bg-blue-700">
    <span class="text-lg font-light">+</span>
    Novo
  </button>
</div>

<!-- LISTA DE CONVITES ENVIADOS -->
<div class="rounded-md bg-white p-4 shadow">

  <!-- TOPO DA LISTA -->
  <div class="rounded-md bg-white p-4 shadow">
    <div class="flex items-center justify-between mb-3">
      <p class="text-gray-800 text-sm font-medium">Convites enviados:</p>

      <!-- BOTÃO DE RELOAD -->
      <button (click)="loadSentInvites()"
        class="p-2 rounded-md hover:bg-gray-200 transition flex items-center justify-center">

        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"
          class="h-5 w-5 text-gray-700">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M16.023 9.348h4.992V4.356m-16.008.087A9.004 9.004 0 0112 3c4.97 0 9 4.03 9 9" />
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M7.977 14.652H2.985v4.992m16.008-.087A9.004 9.004 0 0112 21c-4.97 0-9-4.03-9-9" />
        </svg>

      </button>

    </div>

    <!-- INPUT DE BUSCA -->
    <input type="text" [(ngModel)]="searchTerm" (input)="filterInvites()" placeholder="Buscar por e-mail ou CPF..."
      class="w-full rounded-md border px-3 py-2 text-sm mb-3 focus:ring-blue-500 focus:border-blue-500" />
  </div>


  <!-- Loading -->
  <div *ngIf="isListLoading" class="text-gray-500 text-sm">Carregando convites...</div>

  <!-- Erro -->
  <div *ngIf="listError" class="text-red-600 text-sm">{{ listError }}</div>

  <!-- Lista -->
  <div *ngIf="!isListLoading && !listError">

    <div *ngIf="filteredInvites.length === 0" class="text-gray-400 text-sm">
      Nenhum convite encontrado.
    </div>

    <div *ngFor="let invite of filteredInvites" class="border rounded-md p-3 mb-2 text-sm bg-white relative">

      <!-- LINHA SUPERIOR: STATUS -->
      <div class="flex justify-between items-start mb-2">
        <!-- Esquerda -->
        <div class="space-y-0.5">
          <div><strong>Email:</strong> {{ invite.email }}</div>
          <div><strong>CPF:</strong> {{ invite.cpf }}</div>
          <div><strong>Status:</strong> {{ translateStatus(invite.status) }}</div>
          <div><strong>Criado em:</strong> {{ invite.created_at | date:'dd/MM/yyyy HH:mm' }}</div>
        </div>

        <!-- Direita: Caixa de status -->
        <div class="flex flex-col items-end">
          <span class="px-3 py-1 text-xs rounded-md border font-medium" [ngClass]="{
              'bg-green-50 text-green-700 border-green-300': invite.status === 'accepted' || invite.status === 'completed',              
              'bg-yellow-50 text-yellow-700 border-yellow-300': invite.status === 'pending' || invite.status === 'sent',              
              'bg-red-50 text-red-700 border-red-300': invite.status === 'cancelled' || invite.status === 'expired',              
              'bg-gray-100 text-gray-600 border-gray-300': invite.status?.includes('step_') || !invite.status
            }">
            {{ translateStatus(invite.status) }}
          </span>

          <!-- Botões de ação -->
          <div class="flex gap-2 mt-2">
            <button class="text-blue-600 cursor-pointer hover:underline text-xs" (click)="openInviteDetails(invite)">Ver
              detalhes</button>

            <!-- Botões futuros -->
            <button class="text-yellow-600 hover:underline text-xs opacity-50 cursor-not-allowed">
              Reenviar
            </button>
            <button (click)="cancelInvite(invite)"
                [disabled]="invite.status !== 'pending'"
                [ngClass]="{
                    'opacity-50 cursor-not-allowed text-gray-400': invite.status !== 'pending',
                    'hover:underline text-red-600': invite.status === 'pending'
                }"
                class="text-xs transition-colors">
                Cancelar
            </button>
          </div>
        </div>
      </div>

    </div>

  </div>
</div>


<!-- MODAL -->
<div *ngIf="isModalOpen" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40"
  (click.self)="closeInviteModal()" tabindex="-1" (keydown.escape)="closeInviteModal()">
  <div class="flex w-full max-w-2xl flex-col rounded-lg bg-white shadow-xl max-h-[90vh]">

    <!-- HEADER -->
    <div class="border-b p-4">
      <h2 class="text-lg font-semibold text-gray-800">Enviar convite</h2>
      <p class="text-gray-600 text-sm">Siga as etapas para convidar um novo usuário.</p>
    </div>

    <!-- STEPPER -->
    <nav class="flex justify-around border-b p-3 text-sm">
      <span [class.text-blue-600]="currentStep >= 1" [class.text-gray-400]="currentStep < 1">1. Dados</span>
      <span [class.text-blue-600]="currentStep >= 2" [class.text-gray-400]="currentStep < 2">2. Perfis</span>
      <span [class.text-blue-600]="currentStep >= 3" [class.text-gray-400]="currentStep < 3">3. Atribuição</span>
      <span [class.text-blue-600]="currentStep >= 4" [class.text-gray-400]="currentStep < 4">4. Confirmar</span>
    </nav>

    <!-- CONTENT -->
    <div class="flex-1 overflow-y-auto p-4 text-sm">

      <!-- STEP 1 -->
      <section *ngIf="currentStep === 1">
        <h4 class="mb-4 text-base font-semibold text-gray-800">Dados pessoais</h4>

        <div class="space-y-3">
          <!-- EMAIL -->
          <div>
            <label class="block text-xs font-medium text-gray-700">E-mail</label>
            <input type="email" [(ngModel)]="inviteEmail" required placeholder="Digite o e-mail"
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-1.5 text-sm focus:border-blue-500 focus:ring-blue-500" />
            <p *ngIf="fieldErrors?.email" class="text-xs text-red-600 mt-1">{{ fieldErrors.email[0] }}</p>
          </div>

          <!-- CPF -->
          <div>
            <label class="block text-xs font-medium text-gray-700">CPF</label>
            <input type="text" [(ngModel)]="inviteCpf" required placeholder="Digite o CPF (11 dígitos)"
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-1.5 text-sm focus:border-blue-500 focus:ring-blue-500" />
            <p *ngIf="fieldErrors?.cpf" class="text-xs text-red-600 mt-1">{{ fieldErrors.cpf[0] }}</p>
          </div>

          <div *ngIf="errorMessage" class="text-xs text-red-700">{{ errorMessage }}</div>
        </div>
      </section>

      <!-- STEP 2 -->
      <section *ngIf="currentStep === 2">
        <h4 class="mb-4 text-base font-semibold text-gray-800">Seleção de Perfis</h4>
        <p class="mb-3 text-gray-600 text-xs">Selecione um ou mais perfis.</p>

        <div class="grid grid-cols-2 gap-3">
          <!-- LISTA DE PERFIS -->
          <div class="space-y-2">
            <label *ngFor="let profile of allProfiles"
              class="flex cursor-pointer items-start gap-2 rounded-md border p-3 transition-colors text-sm"
              [class.border-blue-600]="selectedProfiles[profile.id]" [class.bg-blue-50]="selectedProfiles[profile.id]">
              <input type="checkbox" class="mt-1 h-4 w-4" [(ngModel)]="selectedProfiles[profile.id]"
                [disabled]="getBlockedProfilesForCurrentUser().includes(profile.id)" />

              <div>
                <span class="font-medium"
                  [class.text-gray-400]="getBlockedProfilesForCurrentUser().includes(profile.id)">
                  {{ profile.name }}
                </span>
                <p class="text-xs text-gray-600">{{ profile.description }}</p>
              </div>
            </label>
          </div>

          <!-- RESUMO -->
          <div class="rounded-md border bg-gray-50 p-3">
            <h5 class="text-sm font-semibold text-gray-800">Resumo</h5>

            <ul *ngIf="getSelectedProfileNames().length > 0; else noSelection"
              class="mt-2 list-disc list-inside space-y-1 text-xs text-gray-700">
              <li *ngFor="let name of getSelectedProfileNames()">{{ name }}</li>
            </ul>

            <ng-template #noSelection>
              <p class="mt-2 text-xs text-gray-500">Nenhum perfil selecionado.</p>
            </ng-template>
          </div>
        </div>
      </section>

      <!-- STEP 3 -->
      <section *ngIf="currentStep === 3">
        <h4 class="mb-3 text-base font-semibold text-gray-800">Atribuição</h4>

        <!-- REGIONAL -->
        <div
          *ngIf="currentUserRoleSlug === 'national_admin' && (selectedProfiles[2] || selectedProfiles[3] || selectedProfiles[4] || selectedProfiles[5])"
          class="mb-3">
          <label class="block text-xs font-medium text-gray-700">Escolha a Região</label>

          <select [(ngModel)]="selectedRegionalDepartmentId" (ngModelChange)="onRegionalDepartmentChange()"
            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-1.5 text-sm">
            <option [ngValue]="null">Selecione...</option>
            <option *ngFor="let r of regionalDepartments" [ngValue]="r.id">{{ r.name }}</option>
          </select>
        </div>

        <!-- UO -->
        <div *ngIf="(selectedProfiles[3] || selectedProfiles[4] || selectedProfiles[5]) &&
                 (currentUserRoleSlug === 'regional_admin' ||
                  (currentUserRoleSlug === 'national_admin' && selectedRegionalDepartmentId))" class="mb-3">
          <label class="block text-xs font-medium text-gray-700">Escolha a Escola</label>

          <div class="max-h-48 overflow-y-auto border rounded p-2">
            <label *ngFor="let u of operationalUnitsDisplayed"
              class="flex items-center gap-2 p-2 hover:bg-gray-50 text-sm">
              <input type="checkbox" [checked]="selectedAdminSchoolIds[u.id]" (change)="toggleSelectAdminSchool(u.id)"
                class="h-4 w-4" />

              <div>
                <div class="text-sm font-medium">{{ u.name }}</div>
                <div class="text-xs text-gray-500">
                  Região: {{ getRegionalDepartmentName(u.regional_department_id ?? null) }}
                </div>
              </div>
            </label>

            <div *ngIf="operationalUnitsDisplayed.length === 0" class="p-3 text-center text-xs text-gray-500">
              Nenhuma escola encontrada.
            </div>
          </div>
        </div>

        <div *ngIf="errorMessage" class="text-xs text-red-700 mt-2">{{ errorMessage }}</div>
      </section>

      <!-- STEP 4 -->
      <section *ngIf="currentStep === 4" class="text-center">
        <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-blue-100 text-blue-600">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
          </svg>
        </div>

        <h4 class="mt-4 text-lg font-semibold text-gray-800">Confirmar envio do convite</h4>
        <p class="mt-1 text-gray-600 text-sm">Revise os dados abaixo antes de enviar.</p>

        <div class="mt-3 space-y-1 text-left max-w-md mx-auto text-sm">
          <div><strong>E-mail:</strong> {{ inviteEmail }}</div>
          <div><strong>CPF:</strong> {{ inviteCpf }}</div>
          <div><strong>Perfis:</strong> {{ getSelectedProfileNames().join(', ') || '—' }}</div>

          <div *ngIf="selectedRegionalDepartmentId">
            <strong>Região:</strong> {{ getRegionalDepartmentName(selectedRegionalDepartmentId) }}
          </div>

          <div *ngIf="hasSelectedSchools()">
            <strong>Escola:</strong> {{ getSelectedSchoolNames().join(', ') }}
          </div>
        </div>

        <div *ngIf="errorMessage" class="text-xs text-red-700 mt-2">{{ errorMessage }}</div>
        <div *ngIf="successMessage" class="text-xs text-green-700 mt-2">{{ successMessage }}</div>
      </section>

    </div>

    <!-- FOOTER -->
    <div class="flex justify-between border-t bg-gray-50 p-4 text-sm">
      <button (click)="closeInviteModal()" class="rounded-md px-4 py-2 font-medium text-gray-700 hover:bg-gray-200">
        Cancelar
      </button>

      <div class="flex gap-2">
        <button *ngIf="currentStep > 1" (click)="goToPreviousStep()" [disabled]="isLoading"
          class="rounded-md px-4 py-2 font-medium text-gray-700 hover:bg-gray-200 disabled:opacity-50">
          Voltar
        </button>

        <button *ngIf="currentStep < 4" (click)="goToNextStep()" [disabled]="isLoading"
          class="rounded-md bg-blue-600 px-5 py-2 font-medium text-white shadow hover:bg-blue-700 disabled:opacity-50">
          <span *ngIf="!isLoading">Continuar</span>
          <span *ngIf="isLoading">Aguarde...</span>
        </button>

        <button *ngIf="currentStep === 4" (click)="sendInvite()" [disabled]="isLoading"
          class="rounded-md bg-green-600 px-5 py-2 font-medium text-white shadow hover:bg-green-700 disabled:opacity-50">
          <span *ngIf="!isLoading">Convidar</span>
          <span *ngIf="isLoading">Enviando...</span>
        </button>
      </div>
    </div>

  </div>
</div>

<div *ngIf="isDetailsModalOpen" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40"
  (click.self)="closeDetailsModal()" tabindex="-1" (keydown.escape)="closeDetailsModal()">
  
  <div class="flex w-full max-w-lg flex-col rounded-lg bg-white shadow-xl animate-fade-in">
    
    <div class="flex items-center justify-between border-b p-4 bg-gray-50 rounded-t-lg">
      <div>
        <h2 class="text-lg font-semibold text-gray-800">Detalhes do Convite</h2>
        <p class="text-xs text-gray-500">Informações completas do registro.</p>
      </div>
      <button (click)="closeDetailsModal()" class="text-gray-400 hover:text-gray-600">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <div class="p-6 space-y-4 text-sm text-gray-700" *ngIf="selectedInvite">
      
      <div class="flex justify-center mb-4">
        <span class="px-4 py-1.5 rounded-full text-sm font-semibold border" [ngClass]="{
          'bg-green-100 text-green-800 border-green-200': selectedInvite.status === 'sent' || selectedInvite.status === 'accepted',
          'bg-yellow-100 text-yellow-800 border-yellow-200': selectedInvite.status === 'pending',
          'bg-red-100 text-red-800 border-red-200': selectedInvite.status === 'cancelled' || selectedInvite.status === 'expired'
        }">
          {{ translateStatus(selectedInvite.status) }}
        </span>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-xs font-medium text-gray-500 uppercase">E-mail</label>
          <p class="font-medium text-gray-900">{{ selectedInvite.email }}</p>
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-500 uppercase">CPF</label>
          <p class="font-medium text-gray-900">{{ selectedInvite.cpf }}</p>
        </div>
        
        <div>
          <label class="block text-xs font-medium text-gray-500 uppercase">Data de Envio</label>
          <p>{{ selectedInvite.created_at | date:'dd/MM/yyyy HH:mm' }}</p>
        </div>
        
        <div *ngIf="selectedInvite.expires_at">
          <label class="block text-xs font-medium text-gray-500 uppercase">Válido até</label>
          <p [class.text-red-600]="isExpired(selectedInvite.expires_at)">
            {{ selectedInvite.expires_at | date:'dd/MM/yyyy' }}
          </p>
        </div>
      </div>

      <hr class="border-gray-100">

      <div>
        <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Perfis Atribuídos</label>
        <div class="flex flex-wrap gap-2">
             <span class="bg-blue-50 text-blue-700 px-2 py-1 rounded text-xs border border-blue-100">
                {{ selectedInvite.role_name || '—' }}
             </span>
        </div>
      </div>

       <div class="grid grid-cols-2 gap-4">
        <div *ngIf="selectedInvite.regional_department">
            <label class="block text-xs font-medium text-gray-500 uppercase">Departamento Regional</label>
            <p>{{ selectedInvite.regional_department.name }}</p>
        </div>
        <div *ngIf="selectedInvite.operational_unit">
            <label class="block text-xs font-medium text-gray-500 uppercase">Unidade Operacional</label>
            <p>{{ selectedInvite.operational_unit.name }}</p>
        </div>
      </div>

    </div>

    <div class="flex justify-end gap-3 border-t bg-gray-50 p-4 rounded-b-lg">
      
      <button *ngIf="selectedInvite?.status === 'pending'" 
        (click)="cancelInvite(selectedInvite)"
        class="flex items-center gap-2 px-4 py-2 bg-white border border-red-200 text-red-600 text-sm font-medium rounded-md hover:bg-red-50 transition shadow-sm">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
        Cancelar Convite
      </button>

      <button (click)="closeDetailsModal()" class="px-4 py-2 bg-gray-800 text-white text-sm font-medium rounded-md hover:bg-gray-900 transition shadow-sm">
        Fechar
      </button>
    </div>

  </div>
</div>